#!/usr/bin/env bash

set -euo pipefail

command=${1:-}
args=${@:2}
first_arg=${2:-}

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
	HARPOON_ROOT="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
	SOURCE="$( readlink "$SOURCE" )"
	[[ ${SOURCE} != /* ]] && SOURCE="$HARPOON_ROOT/$SOURCE"
done
export HARPOON_ROOT="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

export TASKS_ROOT=${HARPOON_ROOT}/tasks
export SERVICES_ROOT=${HARPOON_ROOT}/services
export VENDOR_ROOT=${HARPOON_ROOT}/vendor
export IMAGES_ROOT=${HARPOON_ROOT}/images
export LIB_ROOT=${HARPOON_ROOT}/lib

if [[ "$command" == "initpath" ]]; then
	echo "${HARPOON_ROOT}/completion/init.sh" && exit 0
fi


# functions
for f in $(ls ${HARPOON_ROOT}/core/func); do
	source ${HARPOON_ROOT}/core/func/${f}
done


# variables
for f in $(ls ${HARPOON_ROOT}/core/vars); do
	source ${HARPOON_ROOT}/core/vars/${f}
done

source ${HARPOON_ROOT}/core/parse.sh

MODULE_NAME=$(parse_module ${command})

if [[ -v USE_DIND && "$MODULE_NAME" != "dind" ]]; then
	print_info "Harpoon is running in dind mode"
	${DIND_EXEC_TTY} harpoon "$@"
	exit $?
fi

# this should always be loaded AFTER core vars and func
source ${HARPOON_ROOT}/core/boot.sh

source ${TASKS_ROOT}/tasks.sh

source ${SERVICES_ROOT}/services.sh

# setup temp directory
mkdir -p ${HARPOON_TEMP}

case "${command}" in
	compose) ## <arg>... %% üê≥  Run docker-compose for the Harpoon core services
		${HARPOON_DOCKER_COMPOSE} ${args} ;;

	cmplt)
		source ${HARPOON_ROOT}/completion/completion.sh ;;

	gen-dnsmasq)
		generate_dnsmasq_config ;;

	config-docker)
		config_docker ;;

	config-docker-network)
		config_docker_network ;;

	env) ## %% Show environment variables
		if [ -v PAGER ]; then
			env | sort | ${PAGER}
		else
			env | sort
		fi
		;;

	help) ## [<task> | <service>] %% ‚ÅâÔ∏è  Get help
		help ;;

	--help|-h)
		help ;;

	show-docker-host-ip)
		echo ${HARPOON_DOCKER_HOST_IP} ;;

	up) ## %% üèÅ  Install Harpoon and start core services
		up ;;

	install) ## %% Alias for `up`
		up ;;

	down) ## [<all>] %% üîΩ  Stop and remove Harpoon core, and optionally, supporting services
		down ${args} ;;

	uninstall) ## [<all>] %% Alias for `down`
		down ${args} ;;

	reset) ## %% üåØ  Stop, remove, and restart Harpoon core services
		reset ;;

	self-update) ## %% üí´  Update Harpoon and plugins
		self_update ;;

	selfupdate) ## %% Alias for `self-update`
		self_update ;;

	clean) ## [<all>] %% üõÄ  Completely uninstall Harpoon core, and optionally, all supporting services
		clean ${args} ;;

	services:ls) ## %% Alias for `services:list`
		services ;;

	services:list) ## %% üëì  List services available in Harpoon
		services ;;

	services:status) ## %% üö¶  Display the status for all supporting services
		services_status ;;

	status) ## %% üö•  Display the status of Harpoon core services
		DOWN_HOSTS=0
		for i in dnsmasq consul traefik; do
			IS_UP=$(${HARPOON_DOCKER_COMPOSE} ps ${i} | grep 'Up') || true
			if [[ ${IS_UP} ]]; then
				printf "%-20s%s\n" "${i}" "${UP}"
			else
				printf "%-20s%s\n" "${i}" "${DOWN}"
				DOWN_HOSTS+=1
			fi
		done
		if [ ${DOWN_HOSTS} -gt 0 ]; then
			exit 1
		fi
		;;

	tasks:ls) ## %% Alias for `tasks:list`
		tasks ;;

	tasks:list) ## %% üëì  List tasks available in Harpoon
		tasks ;;

	service) ## <name> <command> [<arg>...] %% üçΩ  Run a (docker-compose) command or task for a service
		source ${SERVICES_ROOT}/tasks.sh ;;

	stfu) ## %% ü§ê  Please stop talking
		echo "export HARPOON_SPEECH=false" >> $HOME/harpoon.env.sh ;;

	greet)
		speak_greeting ;;

	radio)
		say -v Fred -r 190 "Fitter. Happier. More productive." ;;

	*)
		if [ "${MODULE_NAME}" == "" ]; then all_help; fi

		# try tasks
		task_exists ${MODULE_NAME}

		if [ -v TASK_ROOT ]; then
			if [[ "${first_arg:-}" == "--help" || "${first_arg:-}" == "-h" ]]; then
				task_help ${MODULE_NAME}
				exit $?
			fi

			source ${TASK_ROOT}/handler.sh
		else
			# try services
			service_exists ${MODULE_NAME}

			if [ -v SERVICE_ROOT ]; then
				handle_service ${MODULE_NAME} ${command};
			elif [ -v ROOT_TASKS_FILE ]; then
				# try custom task/command handler in working directory
				command=${command#${PROJECT_TASK_PREFIX}:}
				source ${ROOT_TASKS_FILE}
			fi
		fi
esac
